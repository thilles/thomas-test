name: Splunk Package, Vet and app
on: [push]
jobs:
  Package-and-Inspect-app:
    id: build
    runs-on: ubuntu-latest
    outputs:
      appname: ${{ steps.appname.outputs.buildpkg }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      
      - name: Download Splunk Packaging Toolkit (SLIM)
        run: |
          wget https://download.splunk.com/misc/packaging-toolkit/splunk-packaging-toolkit-1.0.1.tar.gz

      - name: Install SLIM
        run: |
          pip install splunk-packaging-toolkit-1.0.1.tar.gz

      - name: Generate app manifest
        run: |
          slim generate-manifest TA-app -o TA-app/app.manifest

      - name: Package app
        run: |
          mkdir tmp && slim package TA-app --output-dir=tmp

      - name: Getting app name and version
        id: appname
        run: |
          echo "BUILDPKG=$(basename tmp/*tar.gz)" >> $GITHUB_ENV
          echo "::set-output name=buildpkg::${{ env.BUILDPKG }}"
      - name: Run Splunk AppInspect
        uses: splunk/appinspect-cli-action@v1.4.7-publish
        with:
          app_path: tmp/${{ env.BUILDPKG }}
          included_tags: cloud

      - name: Upload AppInspect Results
        uses: actions/upload-artifact@v2
        with:
          name: "${{ env.BUILDPKG }}"
          path: tmp/${{ env.BUILDPKG }}

  Create-release-package:
    needs: Package-and-Inspect-app
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{needs.build.outputs.appname}}
      - name: Get tag version from file name
        run: echo "APP_VERSION=$(echo ${{needs.build.outputs.appname}} | grep --perl-regexp '\d\.\d\.\d' --only-matching)" >> $GITHUB_ENV
      - name: Create release
        uses: AButler/upload-release-assets@v2.0
        with:
          files: tmp/${{ env.BUILDPKG }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          release-tag: v"${{ env.APP_VERSION }}"